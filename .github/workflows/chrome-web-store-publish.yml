name: ğŸš€ Chrome Web Store Auto-Publish

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.1.0)'
        required: true
        default: '1.1.0'
      draft:
        description: 'Publish as draft'
        type: boolean
        default: false

jobs:
  publish-to-chrome-store:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¥ Install Dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build Extension
      run: |
        echo "ğŸ¯ Building Open Web Inspector Extension..."
        npm run build
        echo "âœ… Build complete!"
        
    - name: ğŸ“‹ Extract Version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
          VERSION=${VERSION#v}  # Remove 'v' prefix if present
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Publishing version: $VERSION"
        
    - name: ğŸ”„ Update Extension Version
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        echo "ğŸ“ Updating manifest.json to version $VERSION..."
        
        # Update manifest.json version
        sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" extensions/chrome/manifest.json
        
        # Update popup.html version
        sed -i "s/Extension v[0-9.]*/Extension v$VERSION/" extensions/chrome/popup.html
        
        echo "âœ… Version updated to $VERSION"
        
    - name: ğŸ“¦ Create Chrome Extension Package
      run: |
        echo "ğŸ“¦ Creating Chrome Web Store package..."
        cd extensions/chrome
        
        # Create clean package excluding docs and development files
        zip -r "../../open-web-inspector-chrome-extension-v${{ steps.version.outputs.VERSION }}.zip" . \
          -x "*.md" "*.DS_Store" "README*" "ICON_REQUIREMENTS*" "*.log"
        
        cd ../..
        
        # Verify package contents
        echo "ğŸ“‹ Package contents:"
        unzip -l "open-web-inspector-chrome-extension-v${{ steps.version.outputs.VERSION }}.zip"
        
        echo "âœ… Package created successfully!"
        
    - name: ğŸš€ Publish to Chrome Web Store
      uses: mnao305/chrome-extension-upload@v4.0.1
      with:
        file-path: ./open-web-inspector-chrome-extension-v${{ steps.version.outputs.VERSION }}.zip
        extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
        client-id: ${{ secrets.CHROME_CLIENT_ID }}
        client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
        refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
        publish: ${{ github.event.inputs.draft != 'true' }}
        
    - name: ğŸ“Š Create Release Summary
      run: |
        cat << EOF >> $GITHUB_STEP_SUMMARY
        ## ğŸš€ Chrome Web Store Publication Complete!
        
        ### ğŸ“¦ **Extension Details:**
        - **Version:** \`${{ steps.version.outputs.VERSION }}\`
        - **Package:** \`open-web-inspector-chrome-extension-v${{ steps.version.outputs.VERSION }}.zip\`
        - **Trigger:** ${{ github.event_name }}
        - **Published:** ${{ github.event.inputs.draft != 'true' && 'âœ… Live' || 'ğŸ“ Draft' }}
        
        ### ğŸ¯ **What's New:**
        - Natural Language AI Interface
        - Enhanced UI with gradient design
        - Professional logo integration
        - Improved keyboard shortcuts
        
        ### ğŸ”— **Links:**
        - **Chrome Web Store:** [View Extension](https://chrome.google.com/webstore/detail/${{ secrets.CHROME_EXTENSION_ID }})
        - **Release Notes:** [View Release](${{ github.event.release.html_url }})
        
        ### ğŸ“ˆ **Next Steps:**
        1. Monitor Chrome Web Store review process (1-3 business days)
        2. Check user feedback and ratings
        3. Prepare marketing materials
        4. Monitor analytics and usage metrics
        
        **ğŸ‰ Congratulations! Your extension is now live on the Chrome Web Store!**
        EOF
        
    - name: ğŸ‰ Success Notification
      if: success()
      run: |
        echo "ğŸŠ SUCCESS! Extension v${{ steps.version.outputs.VERSION }} published to Chrome Web Store!"
        echo "ğŸ”— Check status at: https://chrome.google.com/webstore/detail/${{ secrets.CHROME_EXTENSION_ID }}"
        
    - name: âš ï¸ Failure Notification  
      if: failure()
      run: |
        echo "âŒ Publication failed! Check the logs above for details."
        echo "ğŸ’¡ Common issues:"
        echo "   - Check Chrome Web Store API credentials"
        echo "   - Verify extension ID is correct"
        echo "   - Ensure manifest.json is valid"
        echo "   - Check for policy violations"
        
    - name: ğŸ“¤ Upload Package Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: chrome-extension-v${{ steps.version.outputs.VERSION }}
        path: open-web-inspector-chrome-extension-v${{ steps.version.outputs.VERSION }}.zip
        retention-days: 30
